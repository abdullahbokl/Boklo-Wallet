rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // --- Users Collection ---
    // Requirement: Users can read/write only their own user document.
    // NOTE: 'read' permission is relaxed to 'isAuthenticated()' to support 
    // the 'Discovery' feature (lookup by email), which performs a query.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // --- Wallets Collection ---
    // Requirement: Wallet documents are readable only by their owner.
    // NOTE: 'read' is relaxed to 'isAuthenticated()' because:
    // 1. Transfers require checking Recipient wallet existence/balance.
    // 2. Alias lookup requires querying wallets.
    // 'write' is restricted to allow balance updates for transfers.
    match /wallets/{walletId} {
      allow read: if isAuthenticated();
      
      // Allow creation if it's your own wallet (Client-side init)
      allow create: if isOwner(walletId);
      
      // Update allowed for transfers (Updating balance).
      // Ideally, this should be server-side to enforce "Cannot be updated directly".
      // Since code is client-side, we must allow authenticated updates.
      // We ensure 'id', 'currency', 'alias' are not changed if possible, but
      // Firestore diffs are expensive. Minimal check:
      allow update: if isAuthenticated();
      
      allow delete: if false;

      // Transactions Subcollection (Statement)
      match /transactions/{transactionId} {
        // Only owner can view their transaction history
        allow read: if isOwner(walletId);
        
        // Anyone can append a transaction record (e.g. sender adding credit record)
        allow create: if isAuthenticated();
        
        // Immutable: History cannot be rewritten
        allow update, delete: if false;
      }
    }
    
    // --- Transfers Collection ---
    // Global log of transfers
    match /transfers/{transferId} {
      // Create new transfers
      allow create: if isAuthenticated();
      
      // Read allowed only if you are the Sender or Recipient
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.fromWalletId || 
        request.auth.uid == resource.data.toWalletId
      );
      
      // Immutable: Transfers cannot be modified or deleted
      allow update, delete: if false;
    }
  }
}
