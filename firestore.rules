rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Updates must go through backend for critical fields, allowing client to update trivial stuff?
      // Requirement: "Backend-authoritative profile update flow"
      // So we deny client writes to username/name directly ideally.
      // But maybe we allow other fields. For now, strict:
      allow create: if false; // backend creates
      allow update: if false; // backend updates via setUserProfile
      allow delete: if false;
      
      // Allow users to manage their own FCM tokens
      match /tokens/{token} {
        allow write: if isOwner(userId);
        allow read: if isOwner(userId);
      }

      // Contacts Subcollection
      match /contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }

      // Preferences Subcollection
      match /preferences/{prefId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // --- Usernames Registry ---
    match /usernames/{username} {
        allow read: if isAuthenticated(); // Allow reading to check existence (though backend provides check, simple read is checking existence) OR resolving
        allow write: if false; // Backend only
    }
    
    // --- Payment Requests ---
    match /payment_requests/{requestId} {
      allow create: if isAuthenticated()
                    && request.resource.data.requesterId == request.auth.uid
                    && request.resource.data.status == 'PENDING';
                    
      allow read: if isAuthenticated() && (
        resource.data.requesterId == request.auth.uid ||
        resource.data.payerId == request.auth.uid
      );
      
      allow update, delete: if false; // Backend only via Callable
    }
    
    // --- Wallets Collection ---
    match /wallets/{walletId} {
      // 1. Read: Publicly readable for authenticated users (required for discovery)
      allow read: if isAuthenticated();
      
      // 2. Create: Deny. Backend creates wallet on user signup.
      allow create: if false;
      
      // 3. Update:
      //    BACKEND-AUTHORITY:
      //    - Deny modifying 'balance'.
      //    - Deny modifying 'id' or 'currency'.
      //    - Allow modifying 'alias' (if we implement that feature).
      //    - Must be Owner.
      allow update: if isOwner(walletId) 
                    && request.resource.data.balance == resource.data.balance
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.currency == resource.data.currency;
      
      allow delete: if false;

      // Transactions Subcollection
      match /transactions/{transactionId} {
        allow read: if isOwner(walletId);
        // 4. Write: Deny ALL client writes.
        //    BACKEND-AUTHORITY: Only the Cloud Function creates transaction history.
        allow write: if false;
      }

      // Ledger Subcollection (Dev/Debug)
      match /ledger/{entryId} {
        // Only allow the wallet owner to read their own ledger
        allow read: if isOwner(walletId);
        allow write: if false;
      }
    }
    
    // --- Transfers Collection ---
    match /transfers/{transferId} {
      // 5. Create:
      //    BACKEND-AUTHORITY:
      //    - Client requests a transfer by creating a document.
      //    - Must be the sender.
      //    - Must start as 'pending'.
      //    - Must have validation basics.
      allow create: if isAuthenticated()
                    && request.resource.data.fromWalletId == request.auth.uid
                    && request.resource.data.status == 'pending'
                    && request.resource.data.amount > 0;

      // 6. Read: Involved parties (Sender/Receiver) OR if checking existence of new ID
      allow read: if isAuthenticated() && (
        resource == null ||
        request.auth.uid == resource.data.fromWalletId || 
        request.auth.uid == resource.data.toWalletId
      );
      
      // 7. Update/Delete: Deny.
      //    BACKEND-AUTHORITY: Only Cloud Function updates status to COMPLETED/FAILED.
      allow update, delete: if false;
    }

    // --- Global Ledger (Audit Only) ---
    match /ledger/{entryId} {
        // Disallow client reads to prevent seeing other users' data.
        allow read, write: if false;
    }
    
    // --- Events (Audit Only) ---
    match /events/{eventId} {
         allow read, write: if false;
    }
  }
}
