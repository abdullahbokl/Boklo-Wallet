rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper: Verify logic for transfer-based balance updates
    function isValidTransferUpdate() {
      // 1. Only 'balance' field can be changed
      // 2. Ensuring the update is part of a batch that strictly includes
      //    a new Transfer document creation would be ideal (getAfter), but
      //    Firestore Rules cannot easily validate simple batch atomic membership 
      //    without complex schema coupling.
      // 
      // Instead, we enforce rudimentary field protection:
      // Prevent changing ID, Currency, Alias.
      let incoming = request.resource.data;
      let existing = resource.data;
      return incoming.id == existing.id 
          && incoming.currency == existing.currency
          && incoming.alias == existing.alias
          && incoming.balance is number;
    }
    
    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // --- Wallets Collection ---
    match /wallets/{walletId} {
      // Relaxed Read for Discovery & Validation
      allow read: if isAuthenticated();
      
      // Allow creation only for own wallet
      allow create: if isOwner(walletId);
      
      // Update: HARDENED
      // - Must be authenticated
      // - Must preserve immutable fields (ID, Currency, Alias)
      // - Only 'balance' can vary
      allow update: if isAuthenticated() && isValidTransferUpdate();
      
      // Deletion not allowed
      allow delete: if false;

      // Transactions Subcollection
      match /transactions/{transactionId} {
        allow read: if isOwner(walletId);
        // Appending records allowed for Transfer execution
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }
    }
    
    // --- Transfers Collection ---
    match /transfers/{transferId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.fromWalletId || 
        request.auth.uid == resource.data.toWalletId
      );
      allow update, delete: if false;
    }
  }
}
